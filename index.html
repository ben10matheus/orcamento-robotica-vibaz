<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vibaz Robótica — Catálogo</title>

<link rel="icon" href="imagens/favicon.svg?v=5" type="image/svg+xml">
<link rel="icon" href="imagens/favicon-32.png?v=5" sizes="32x32" type="image/png">
<link rel="icon" href="imagens/favicon-16.png?v=5" sizes="16x16" type="image/png">
<link rel="shortcut icon" href="imagens/favicon.ico?v=5" type="image/x-icon">
<link rel="apple-touch-icon" href="imagens/favicon-180.png?v=5" sizes="180x180">
<meta name="theme-color" content="#333e63">

<style>
  :root{ --bg:#dfe7ff; --panel:#333e63; --card:#3a4266; --ink:#0e1222; --ink-inv:#ffffff; --line:#2b314a; --media-bg:#ffffff; --media-frame:#333e63; --btn:#6e95ff; --btn-hover:#587ef0; --black:#000; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; background:var(--bg); color:var(--ink); font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; position:relative; }
  body::after{ content:""; position:fixed; inset:0; background:url("imagens/logo.png") no-repeat center calc(100% - 40px) / clamp(240px, 40vw, 520px); opacity:.30; pointer-events:none; z-index:0; }

  header{position:sticky; top:0; z-index:20; background:var(--panel); border-bottom:1px solid var(--line)}
  header .wrap{ max-width:1280px; margin:auto; padding:10px 16px; display:flex; align-items:center; gap:12px }
  .brand{display:flex; align-items:center; gap:10px}
  .brand img{height:72px; display:block; transform:scale(1.2); transform-origin:left center}
  .brand span{color:#cfe0ff; font-weight:700; letter-spacing:.2px}

  .cart-btn{ position:relative; display:inline-flex; align-items:center; justify-content:center; width:42px; height:42px; border-radius:10px; margin-right:10px; background:#44507c; color:#e9efff; cursor:pointer; border:1px solid var(--line) }
  .cart-btn:hover{ background:#3b486f }
  .cart-btn .badge{ position:absolute; top:-6px; right:-6px; display:none; background:#e03131; color:#fff; font-weight:800; font-size:11px; line-height:1; padding:4px 6px; border-radius:999px; min-width:18px; text-align:center; box-shadow:0 0 0 2px var(--panel) }

  .toolbar{ position:relative; z-index:1; max-width:1280px; margin:18px auto 8px; padding:14px 16px; background:var(--panel); border:1px solid var(--line); border-radius:14px; display:grid; grid-template-columns:auto 1fr auto auto auto auto; gap:10px; align-items:end }
  .toolbar label{color:#cfe0ff; font-size:12px; display:block; margin-bottom:6px}
  input,select,button{ padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#f6f8ff; color:#111; outline:none }
  input::placeholder{color:#8088a8}
  .btn{cursor:pointer; background:var(--btn); color:var(--ink-inv); border:none; font-weight:700; border-radius:10px; padding:10px 14px}
  .btn:hover{background:var(--btn-hover)}
  .btn.secondary{background:#44507c; color:#e9efff}
  .btn.danger{background:#e03131; color:#fff}
  .btn.danger:hover{background:#c22020}

  .search-wrap{display:flex; align-items:end; gap:8px}
  #search{width:min(720px, 100%)}
  #btnClearSearch{white-space:nowrap}

  .brand-mini{ display:flex; align-items:center; justify-content:center; padding:6px 10px 2px; background:#2f395a; border:1px solid var(--line); border-radius:12px }
  .brand-mini img{height:56px; display:block}

  main{position:relative; z-index:1; max-width:1280px; margin:8px auto 120px; padding:0 16px}
  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(360px,1fr)); gap:16px}

  .card{border-radius:16px; overflow:hidden; border:3px solid var(--media-frame); background:#eef3ff}
  .media{background:var(--media-bg); border-bottom:3px solid var(--media-frame); display:flex; align-items:center; justify-content:center; aspect-ratio:16/12}
  .media img{max-width:95%; max-height:95%; object-fit:contain}
  .body{background:var(--card); color:#e9efff; border-top:1px solid var(--line); padding:12px}
  .title{font-weight:800; margin:0 0 8px}
  .row{display:flex; gap:8px; margin:8px 0}
  .row>*{flex:1; min-width:0}
  label{display:block; font-size:12px; margin-bottom:4px; opacity:.9}
  .price{background:#2f395e; color:#e9f2ff; border:1px solid #243055; width:100%}
  .qty{background:#eef3ff; width:100%}

  .include-btn{ width:100%; padding:12px 14px; border-radius:12px; font-weight:800; background:var(--btn); color:#fff; border:none; cursor:pointer; box-shadow:0 2px 0 0 #425fb5; white-space:nowrap }
  .include-btn:hover{background:var(--btn-hover)}
  .include-btn.on,
  .include-btn[data-on="1"]{ background:#e03131 !important; box-shadow:0 2px 0 0 #932020 !important; }
  .include-btn.on:hover,
  .include-btn[data-on="1"]:hover{ background:#c22020 !important; }

  .placeholder{ margin:24px auto 0; padding:16px; border:1px dashed #9fb3ff; border-radius:12px; text-align:center; color:#3a4266; background:#f0f4ff; max-width:900px }

  .overlay{ position:fixed; inset:0; background:rgba(18,24,40,.6); display:none; align-items:flex-start; justify-content:center; z-index:50 }
  .overlay.show{display:flex}
  .sheet{ margin:24px; max-width:1180px; width:100%; background:#e8eeff; border:1px solid #a3b0ff; border-radius:14px; box-shadow:0 10px 40px rgba(0,0,0,.35); overflow:hidden; display:flex; flex-direction:column; max-height:92vh }
  .sheet header{position:sticky; top:0; background:#e8eeff; border-bottom:1px solid #a3b0ff; z-index:1}
  .sheet header .bar{display:flex; gap:8px; align-items:center; justify-content:space-between; padding:12px 16px}
  .sheet header h3{margin:0; font-size:18px; color:#222}
  .sheet .meta{font-size:12px; color:#444}
  .sheet .content{padding:14px; overflow:auto}

  .sel-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
  .sel-item{display:flex; gap:12px; border:1px solid #a3b0ff; border-radius:10px; background:#f6f8ff; padding:10px; break-inside:avoid}
  .sel-item .imgbox{width:140px; height:110px; display:flex; align-items:center; justify-content:center; border:1px solid #d8e0ff; border-radius:8px; background:#fff; overflow:hidden}
  .sel-item img{max-width:100%; max-height:100%; object-fit:contain}
  .sel-item .info h4{margin:0 0 6px; font-size:15px}
  .sel-item .info .row{display:flex; gap:24px; font-size:13px}

  .tbl{ width:100%; border-collapse:separate; border-spacing:0; margin-top:12px; background:#fff; border:1px solid var(--black); border-radius:10px; overflow:hidden }
  .tbl th,.tbl td{border:1px solid var(--black); padding:8px}
  .tbl th{background:#eef2ff; text-align:left}
  .right{text-align:right; font-variant-numeric:tabular-nums}
  .tbl tfoot td{font-weight:800}
  .tbl tr{break-inside:avoid}

  @media print{
    @page{ size:A4 landscape; margin:12mm }
    html,body{ background:#fff } body::after{ display:none }
    header,.toolbar,.placeholder,#catalog,.grid,.card,.overlay:not(.print){ display:none !important }
    .overlay.print{ display:block !important; position:static !important; background:transparent !important; -webkit-print-color-adjust:exact; print-color-adjust:exact }
    .sheet .content{ overflow:visible; padding:0 2mm }
  }

  @media (max-width: 768px){
    body{ background:#0e1b3f }
    .toolbar{ grid-template-columns: 1fr; gap:12px }
    .toolbar > div{ width:100% }
    .brand-mini{ justify-content:center } .brand-mini img{ height:42px }
    .search-wrap{ flex-direction: column; align-items: stretch; gap:8px } #search{ width:100%; font-size:16px; padding:12px 14px }
    #btnClearSearch, #btnClear{ width:100% } .grid{ grid-template-columns:1fr }
    .sheet{ margin:12px; max-height:90vh } .sel-grid{ grid-template-columns:1fr }
  }
</style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="brand">
      <img src="imagens/logo-branca.png" alt="Vibaz Robótica" />
      <span>Vibaz Robótica</span>
    </div>

    <div class="cart-btn" id="btnCart" title="Abrir carrinho" aria-label="Abrir carrinho">
      <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true"><path fill="currentColor" d="M7 4H5L4 6v2h2l3.6 7.59-1.35 2.41A2 2 0 0 0 10 20h10v-2H10l1.1-2h6.45c.75 0 1.41-.41 1.75-1.03L22 9H7.42l-.94-2H7V4Zm2 16a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm10 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4Z"/></svg>
      <span class="badge" id="cartBadge">0</span>
    </div>

    <div style="margin-left:auto">
      <button class="btn" id="btnCloseQuote">Fechar orçamento</button>
    </div>
  </div>
</header>

<section class="toolbar">
  <div class="brand-mini" aria-hidden="true"><img src="imagens/logo-branca.png" alt="" /></div>

  <div class="search-wrap">
    <div style="flex:1">
      <label>Pesquisar modelo</label>
      <input id="search" list="sug" placeholder="digite parte do nome..." />
      <datalist id="sug"></datalist>
    </div>
    <button class="btn secondary" id="btnClearSearch">Limpar busca</button>
  </div>

  <div style="align-self:end">
    <label>&nbsp;</label>
    <button class="btn danger" id="btnClear">Limpar carrinho</button>
  </div>

  <div>
    <label>UF do cliente</label>
    <select id="uf">
      <option value="AC">AC</option><option value="AL">AL</option><option value="AP">AP</option>
      <option value="AM">AM</option><option value="BA">BA</option><option value="CE">CE</option>
      <option value="DF">DF</option><option value="ES">ES</option><option value="GO">GO</option>
      <option value="MA">MA</option><option value="MT">MT</option><option value="MS">MS</option>
      <option value="MG">MG</option><option value="PA">PA</option><option value="PB">PB</option>
      <option value="PR" selected>PR</option><option value="PE">PE</option><option value="PI">PI</option>
      <option value="RJ">RJ</option><option value="RN">RN</option><option value="RS">RS</option>
      <option value="RO">RO</option><option value="RR">RR</option><option value="SC">SC</option>
      <option value="SP">SP</option><option value="SE">SE</option><option value="TO">TO</option>
      <!-- Sem "Outros": UF ≠ PR já usa outros.json automaticamente -->
    </select>
  </div>

  <div>
    <label>Distância (Km) — custo somado ao 1º item</label>
    <input id="km" type="number" min="0" step="1" value="0" />
  </div>

  <!-- Botão Produto Personalizado -->
  <div>
    <label>&nbsp;</label>
    <button class="btn" id="btnAddCustom">Adicionar personalizado</button>
  </div>
</section>

<main>
  <!-- Hint oculto como combinado -->
  <div id="hint" class="placeholder" style="display:none"></div>
  <section id="catalog" class="grid"></section>
</main>

<!-- Modal: Produto Personalizado -->
<div id="customProdModal" style="position:fixed;inset:0;background:rgba(18,24,40,.6);display:none;align-items:center;justify-content:center;z-index:99999">
  <div style="width:min(560px,92vw);background:#fff;border:1px solid #cfd7ff;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.35);padding:16px;font:14px/1.4 system-ui,sans-serif">
    <h3 style="margin:0 0 10px">Adicionar produto personalizado</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div style="grid-column:1/-1">
        <label>Nome</label>
        <input id="cp_nome" type="text" placeholder="Ex.: Robô XYZ" style="width:100%;padding:8px 10px;border:1px solid #d0d7ff;border-radius:10px">
      </div>
      <div>
        <label>Valor líquido (R$)</label>
        <input id="cp_liq" type="number" step="0.01" min="0" placeholder="0,00" style="width:100%;padding:8px 10px;border:1px solid #d0d7ff;border-radius:10px">
      </div>
      <div>
        <label>Valor c/ impostos (R$)</label>
        <input id="cp_imp" type="number" step="0.01" min="0" placeholder="0,00" style="width:100%;padding:8px 10px;border:1px solid #d0d7ff;border-radius:10px">
      </div>
      <div>
        <label>Quantidade</label>
        <input id="cp_qtd" type="number" min="1" step="1" value="1" style="width:100%;padding:8px 10px;border:1px solid #d0d7ff;border-radius:10px">
      </div>
      <div style="grid-column:1/-1">
        <label>Imagem (PNG/JPG)</label>
        <input id="cp_img" type="file" accept="image/*" style="width:100%">
        <small style="display:block;color:#566">Opcional. Se não enviar, será usado o fallback por nome.</small>
      </div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
      <button id="cp_cancel" class="btn secondary" type="button">Cancelar</button>
      <button id="cp_save" class="btn" type="button">Adicionar</button>
    </div>
  </div>
</div>

<!-- Preview (opcional) -->
<div class="overlay" id="overlay">
  <div class="sheet" id="sheet">
    <header>
      <div class="bar">
        <div>
          <h3>Orçamento — Vibaz Robótica</h3>
          <div class="meta" id="meta"></div>
        </div>
        <div>
          <button class="btn" id="btnPrint">Imprimir/Salvar PDF</button>
          <button class="btn secondary" id="btnBack">Voltar</button>
        </div>
      </div>
    </header>
    <div class="content">
      <div class="sel-grid" id="selGrid"></div>
      <table class="tbl" id="tbl">
        <thead>
          <tr>
            <th style="width:58%">Produto</th>
            <th style="width:8%">Qtd</th>
            <th class="right" style="width:17%">Total líquido</th>
            <th class="right" style="width:17%">Total c/ impostos</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot>
          <tr><td colspan="4" class="right" id="subLiq">Subtotal valor líquido</td></tr>
          <tr><td colspan="4" class="right" id="subImp">Subtotal valor c/ impostos</td></tr>
          <tr><td colspan="4" class="right" id="totGeral">Total geral</td></tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<!-- Carrinho -->
<div class="overlay" id="cartOverlay">
  <div class="sheet">
    <header>
      <div class="bar">
        <div>
          <h3>Carrinho — Itens selecionados</h3>
          <div class="meta" id="cartMeta"></div>
        </div>
        <div><button class="btn secondary" id="btnCloseCart">Fechar</button></div>
      </div>
    </header>
    <div class="content">
      <div class="sel-grid" id="cartSelGrid"></div>
      <table class="tbl">
        <thead>
          <tr>
            <th style="width:58%">Produto</th>
            <th style="width:8%">Qtd</th>
            <th class="right" style="width:17%">Total líquido</th>
            <th class="right" style="width:17%">Total c/ impostos</th>
          </tr>
        </thead>
        <tbody id="cartTbody"></tbody>
        <tfoot>
          <tr><td colspan="4" class="right" id="cartSubLiq">Subtotal valor líquido</td></tr>
          <tr><td colspan="4" class="right" id="cartSubImp">Subtotal valor c/ impostos</td></tr>
          <tr><td colspan="4" class="right" id="cartTotGeral">Total geral</td></tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<script>
/* ===== Config ===== */
const TARIFA_KM = 1.6;

/* ===== Helpers ===== */
const money = v => isFinite(v) ? v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : '-';
const parseBR = s => { if(typeof s==='number') return s; const x=String(s).replace(/[^\d,.-]+/g,'').replace(/\.(?=\d{3}(\D|$))/g,'').replace(',', '.'); const n=parseFloat(x); return Number.isFinite(n)? n:0; };
function normStr(s){ return String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
function cleanStr(s){ return normStr(s).replace(/[^a-z0-9]+/gi, ' ').trim(); }

/* ===== Imagens ===== */
function candidatesFor(nome){
  const raw = String(nome||'').trim();
  const noAcc = raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  const cleaned = noAcc.replace(/[+]/g,'_').replace(/[^\w.\- ]+/g,'_').replace(/_/g,' ').replace(/\s+/g,' ').trim();
  const u = cleaned.replace(/\s+/g,'_'); const h = cleaned.replace(/\s+/g,'-');
  const bases=[raw,noAcc,cleaned,u,h,raw.toUpperCase(),noAcc.toUpperCase(),cleaned.toUpperCase(),u.toUpperCase(),h.toUpperCase(),raw.toLowerCase(),noAcc.toLowerCase(),cleaned.toLowerCase(),u.toLowerCase(),h.toLowerCase()].filter((v,i,a)=>v&&a.indexOf(v)===i);
  const out=[]; for(const b of bases){ out.push(`imagens/${b}.png`,`imagens/${b}.jpg`,`imagens/${b}.jpeg`); }
  return out;
}
function loadImageWithFallback(img, list, i=0){
  if(i>=list.length){ img.style.display='none'; return; }
  img.onerror=()=>loadImageWithFallback(img,list,i+1);
  img.onload =()=>{ img.style.display='block'; };
  img.src=list[i];
}

/* ===== Estado / DOM ===== */
const state={ uf:'PR', km:0, all:[], filtered:[] };
const $=(s,e=document)=>e.querySelector(s);
const catalog=$('#catalog'), hint=$('#hint'), inputSearch=$('#search'), selectUF=$('#uf'), inputKM=$('#km');
const btnClear=$('#btnClear'), btnClearSearch=$('#btnClearSearch'), btnCloseQuote=$('#btnCloseQuote');

/* ===== Carregar JSON por UF ===== */
async function loadDataByUF(uf) {
  const file = (uf === 'PR') ? 'pr.json' : 'outros.json';
  const candidates = ['./data/' + file, 'data/' + file, '/data/' + file];
  let lastErr = null, data = null;
  for (const url of candidates) {
    try {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status + ' em ' + (res.url || url));
      const txt = await res.text();
      try { data = JSON.parse(txt); } catch (e) { throw new Error('JSON invalido em ' + url + ' — inicio: ' + txt.slice(0, 120) + '...'); }
      break;
    } catch (err) { lastErr = err; }
  }
  if (!data) {
    alert('Nao foi possivel carregar o catalogo.\n' + (lastErr ? String(lastErr) : 'Motivo desconhecido.') + '\n\nVerifique se os arquivos existem:\n • data/pr.json\n • data/outros.json\n\nDica: abra no navegador para testar:\n  http://127.0.0.1:5500/data/pr.json');
    state.all = []; state.filtered = []; catalog.innerHTML = ''; hint.textContent = ''; hint.style.display='none'; updateCartBadge(); return;
  }

  state.all = data.map(function (x) {
    return {
      nome: String(x.nome || x.modelo || x.Nome || '').trim(),
      ad: parseBR(x.ad || x.AD || x.sem_impostos || x.unit_sem || 0),
      an: parseBR(x.an || x.AN || x.com_impostos || x.unit_com || 0),
      qty: 1,
      incluir: 0
    };
  }).filter(function (x) { return x.nome; });

  // Preenche o datalist nativo (azul)
  const sug=document.getElementById('sug');
  if (sug) {
    sug.innerHTML = state.all
      .map(it => `<option value="${String(it.nome).replace(/"/g,'&quot;')}"></option>`)
      .join('');
  }

  state.filtered = [];
  renderCards();
  hint.textContent=''; hint.style.display='none';
  updateCartBadge();
}

/* ===== Render ===== */
function renderCards(){
  catalog.innerHTML='';
  // hint sempre oculto
  if(state.filtered.length===0){ return; }
  state.filtered.forEach(it=>{
    const card=document.createElement('article'); card.className='card'; card.dataset.selected=it.incluir?'1':'0';
    const media=document.createElement('div'); media.className='media';
    media.innerHTML=`<img alt="${it.nome}" style="display:none">`;
    const imgEl=media.querySelector('img');
    if (it.img_custom) {
      imgEl.onerror=()=>{imgEl.style.display='none'};
      imgEl.onload=()=>{imgEl.style.display='block'};
      imgEl.src=it.img_custom;
    } else {
      loadImageWithFallback(imgEl,candidatesFor(it.nome));
    }
    const body=document.createElement('div'); body.className='body';
    body.innerHTML=`
      <div class="title">${it.nome}</div>
      <div class="row">
        <div><label>Valor líquido</label><input class="price" value="${money(it.ad)}" readonly></div>
        <div><label>Valor c/ impostos</label><input class="price" value="${money(it.an)}" readonly></div>
      </div>
      <div class="row">
        <div style="max-width:170px"><label>Quantidade</label><input class="qty" type="number" min="1" step="1" value="${it.qty}"></div>
        <div style="display:flex;align-items:flex-end"><button class="include-btn ${it.incluir? 'on':''}" data-on="${it.incluir?1:0}">${it.incluir?'Remover':'Adicionar ao carrinho'}</button></div>
      </div>`;
    body.querySelector('.qty').addEventListener('input',e=>{
      const v=Math.max(1,parseInt(e.target.value||'1',10)); it.qty=v; e.target.value=v; updateCartBadge();
    });
    body.querySelector('.include-btn').addEventListener('click',()=>{
      it.incluir=it.incluir?0:1; renderCards(); updateCartBadge();
    });
    card.append(media,body); catalog.appendChild(card);
  });
}

/* ===== Busca ===== */
function applyFilter(){
  const q = cleanStr(inputSearch.value.trim());
  if (!q) { state.filtered = []; renderCards(); hint.textContent=''; hint.style.display='none'; return; }
  state.filtered = state.all.filter(it => cleanStr(it.nome).includes(q));
  renderCards();
}

/* ===== Carrinho/Overlay ===== */
function updateCartBadge(){
  const count = state.all
    .filter(it => it.incluir)
    .reduce((s,it)=>s + Number(it.qty||0), 0);
  const b=document.getElementById('cartBadge');
  if(b){ b.textContent = count; b.style.display = count > 0 ? 'inline-block' : 'none'; }
}
function buildCart(){
  const km = Math.max(0, parseInt(inputKM.value||'0',10));
  const custo = km * TARIFA_KM;
  const itensSel = state.all.filter(it=>it.incluir);
  const cartSelGrid=document.getElementById('cartSelGrid'),
        cartTbody=document.getElementById('cartTbody'),
        cartSubLiq=document.getElementById('cartSubLiq'),
        cartSubImp=document.getElementById('cartSubImp'),
        cartTotGeral=document.getElementById('cartTotGeral'),
        cartMeta=document.getElementById('cartMeta');

  cartSelGrid.innerHTML=''; cartTbody.innerHTML='';
  cartSubLiq.textContent='Subtotal valor líquido';
  cartSubImp.textContent='Subtotal valor c/ impostos';
  cartTotGeral.textContent='Total geral';
  cartMeta.textContent=`UF: ${selectUF.value.toUpperCase()} • Distância: ${inputKM.value||0} Km • ${itensSel.length} item(ns)`;

  if(itensSel.length===0){
    cartSelGrid.innerHTML='<div style="grid-column:1/-1;padding:10px;background:#fff;border:1px dashed #a3b0ff;border-radius:10px;text-align:center">Nenhum item no carrinho.</div>';
    return;
  }
  itensSel.forEach((it, idx)=>{
    const totalLiq = (it.ad * it.qty) + (idx===0 ? custo : 0);
    const totalImp = (it.an * it.qty) + (idx===0 ? custo : 0);
    const box=document.createElement('div'); box.className='sel-item';
    box.innerHTML=`<div class="imgbox"><img alt="${it.nome}"></div><div class="info"><h4>${it.nome}</h4><div class="row"><div>Total Líq.: <b>${money(totalLiq)}</b></div><div>Total c/ Imp.: <b>${money(totalImp)}</b></div></div><div>Qtd: <b>${it.qty}</b></div></div>`;
    const img=box.querySelector('img');
    if (it.img_custom) img.src = it.img_custom; else loadImageWithFallback(img,candidatesFor(it.nome));
    cartSelGrid.appendChild(box);

    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.nome}</td><td class="right">${it.qty}</td><td class="right">${money(totalLiq)}</td><td class="right">${money(totalImp)}</td>`;
    cartTbody.appendChild(tr);
  });

  let subtotalLiq=0, subtotalImp=0;
  itensSel.forEach((it,idx)=>{
    subtotalLiq += (it.ad * it.qty) + (idx===0 ? custo : 0);
    subtotalImp += (it.an * it.qty) + (idx===0 ? custo : 0);
  });
  cartSubLiq.textContent = `Subtotal valor líquido       ${money(subtotalLiq)}`;
  cartSubImp.textContent  = `Subtotal valor c/ impostos   ${money(subtotalImp)}`;
  cartTotGeral.textContent= `Total geral                   ${money(subtotalImp)}`;
}
document.getElementById('btnCart')?.addEventListener('click', () => {
  buildCart(); document.getElementById('cartOverlay')?.classList.add('show');
});
document.getElementById('btnCloseCart')?.addEventListener('click', () => {
  document.getElementById('cartOverlay')?.classList.remove('show');
});

/* ========= Confirm + Senha ========= */
function confirmBR(msg){
  return new Promise((resolve)=>{
    const mask=document.createElement('div');
    mask.style.cssText="position:fixed;inset:0;background:rgba(18,24,40,.6);display:flex;align-items:center;justify-content:center;z-index:99999";
    const box=document.createElement('div');
    box.style.cssText="width:min(420px,92vw);background:#1f2937;color:#e5e7eb;border:1px solid #334155;border-radius:12px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.35);font:14px/1.4 system-ui,sans-serif";
    box.innerHTML='<div style="margin-bottom:10px">'+msg+'</div><div style="display:flex;gap:10px;justify-content:flex-end"><button id="btnNao" style="padding:8px 12px;border:1px solid #475569;border-radius:10px;background:#0f172a;color:#e5e7eb;cursor:pointer">Não</button><button id="btnSim" style="padding:8px 12px;border:1px solid #15803d;border-radius:10px;background:#16a34a;color:#fff;cursor:pointer">Sim</button></div>';
    mask.appendChild(box); document.body.appendChild(mask);
    const cleanup=v=>{document.removeEventListener('keydown',onKey); mask.remove(); resolve(v);};
    const onKey=e=>{if(e.key==='Escape')cleanup(false); if(e.key==='Enter')cleanup(true);};
    box.querySelector('#btnSim').addEventListener('click',()=>cleanup(true));
    box.querySelector('#btnNao').addEventListener('click',()=>cleanup(false));
    document.addEventListener('keydown',onKey);
    box.querySelector('#btnSim').focus();
  });
}
function promptSenhaBR(msg){
  return new Promise((resolve)=>{
    const mask=document.createElement('div');
    mask.style.cssText="position:fixed;inset:0;background:rgba(18,24,40,.6);display:flex;align-items:center;justify-content:center;z-index:99999";
    const box=document.createElement('div');
    box.style.cssText="width:min(420px,92vw);background:#1f2937;color:#e5e7eb;border:1px solid #334155;border-radius:12px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.35);font:14px/1.4 system-ui,sans-serif";
    box.innerHTML=`
      <div style="margin-bottom:8px">${msg}</div>
      <input id="pwdIn" type="password" placeholder="Digite a senha" style="width:100%;margin:6px 0 10px;padding:8px 10px;border-radius:10px;border:1px solid #475569;background:#0f172a;color:#e5e7eb;outline:none">
      <div id="pwdErr" style="display:none;color:#fca5a5;font-size:12px;margin:-4px 0 8px">Senha incorreta. Tente novamente.</div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button id="pwdCancel" style="padding:8px 12px;border:1px solid #475569;border-radius:10px;background:#0f172a;color:#e5e7eb;cursor:pointer">Cancelar</button>
        <button id="pwdOk" style="padding:8px 12px;border:1px solid #15803d;border-radius:10px;background:#16a34a;color:#fff;cursor:pointer">Confirmar</button>
      </div>`;
    mask.appendChild(box); document.body.appendChild(mask);
    const inp=box.querySelector('#pwdIn'), err=box.querySelector('#pwdErr');
    const cleanup=v=>{document.removeEventListener('keydown',onKey); mask.remove(); resolve(v);};
    const onKey=e=>{if(e.key==='Escape')cleanup(false); if(e.key==='Enter')submit();};
    function submit(){
      const v=String(inp.value||'').trim();
      if(v==='121419') cleanup(true);
      else { err.style.display='block'; inp.select(); }
    }
    box.querySelector('#pwdOk').addEventListener('click', submit);
    box.querySelector('#pwdCancel').addEventListener('click', ()=>cleanup(false));
    document.addEventListener('keydown', onKey);
    inp.focus();
  });
}

/* ===== Produto personalizado (com senha) ===== */
(function(){
  const modal = document.getElementById('customProdModal');
  const btnOpen = document.getElementById('btnAddCustom');
  const btnCancel = document.getElementById('cp_cancel');
  const btnSave = document.getElementById('cp_save');
  const inNome = document.getElementById('cp_nome');
  const inLiq  = document.getElementById('cp_liq');
  const inImp  = document.getElementById('cp_imp');
  const inImg  = document.getElementById('cp_img');
  const inQtd  = document.getElementById('cp_qtd');

  function openModal(){
    inNome.value=''; inLiq.value=''; inImp.value=''; inImg.value='';
    inQtd.value='1';
    modal.style.display='flex'; inNome.focus();
  }
  function closeModal(){ modal.style.display='none'; }
  function readFileAsDataURL(file){
    return new Promise((res, rej)=>{
      if(!file) return res(null);
      const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=rej; r.readAsDataURL(file);
    });
  }
  async function saveCustom(){
    const ok = await promptSenhaBR('Informe a senha para adicionar produto personalizado:');
    if (!ok) return;

    const nome = inNome.value.trim();
    const liq = Number((inLiq.value||'').replace(',','.'));
    const imp = Number((inImp.value||'').replace(',','.'));
    const qtd = Math.max(1, parseInt(inQtd.value||'1',10) || 1);

    if(!nome){ alert('Informe o nome do produto.'); inNome.focus(); return; }
    if(!(liq>=0) || !(imp>=0)){
      alert('Informe valores numéricos para líquido e impostos.');
      (isNaN(liq)?inLiq:inImp).focus(); return;
    }

    let dataURL = null;
    if(inImg.files && inImg.files[0]){
      try { dataURL = await readFileAsDataURL(inImg.files[0]); } catch {}
    }

    const novo = { nome, ad: liq, an: imp, qty: qtd, incluir: 1, img_custom: dataURL };
    state.all.unshift(novo);

    const q = cleanStr(inputSearch.value.trim());
    if(!q){ state.filtered = []; renderCards(); updateCartBadge(); closeModal(); return; }
    applyFilter(); updateCartBadge(); closeModal();
  }

  btnOpen?.addEventListener('click', (e)=>{ e.preventDefault(); openModal(); });
  btnCancel?.addEventListener('click', (e)=>{ e.preventDefault(); closeModal(); });
  btnSave?.addEventListener('click', (e)=>{ e.preventDefault(); saveCustom(); });
  modal?.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
  document.addEventListener('keydown', (e)=>{ if(modal.style.display==='flex' && e.key==='Escape') closeModal(); });
})();

/* ===== Eventos ===== */
inputSearch.addEventListener('input', applyFilter);
inputSearch.addEventListener('change', applyFilter);
inputSearch.addEventListener('keydown', (e)=>{ if(e.key==='Enter') applyFilter(); });
btnClearSearch.addEventListener('click',(e)=>{
  e.preventDefault(); inputSearch.value=''; applyFilter(); inputSearch.focus();
});
selectUF.addEventListener('change',async()=>{
  state.uf=selectUF.value; await loadDataByUF(state.uf);
});
inputKM.addEventListener('input',e=>{
  state.km=Math.max(0,parseInt(e.target.value||'0',10));
});

btnClear.addEventListener('click', (e) => {
  e.preventDefault();
  const temItens = state.all.some(it => it.incluir);
  if (!temItens) { alert('O carrinho já está vazio.'); return; }
  if (!confirm('Tem certeza que deseja LIMPAR o carrinho?')) return;
  state.all.forEach(it => { it.incluir = 0; it.qty = 1; });
  state.filtered.forEach(it => { it.incluir = 0; it.qty = 1; });
  renderCards(); updateCartBadge();
  const overlay = document.getElementById('cartOverlay');
  if (overlay && overlay.classList.contains('show')) {
    document.getElementById('cartSelGrid').innerHTML = '';
    document.getElementById('cartTbody').innerHTML   = '';
    document.getElementById('cartSubLiq').textContent = 'Subtotal valor líquido';
    document.getElementById('cartSubImp').textContent = 'Subtotal valor c/ impostos';
    document.getElementById('cartTotGeral').textContent = 'Total geral';
    document.getElementById('cartMeta').textContent =
      `UF: ${String(document.getElementById('uf').value).toUpperCase()} • Distância: ${document.getElementById('km').value||0} Km • 0 item(ns)`;
  }
});

/* ===== Fechar orçamento ===== */
function coletarDadosParaProposta(){
  const km = Math.max(0, parseInt(document.querySelector('#km').value||'0',10));
  const uf = document.querySelector('#uf').value;
  const frete = km * TARIFA_KM;
  const itensSel = state.all.filter(it=>it.incluir);
  const itens = itensSel.map((it, idx) => ({
    nome: it.nome, qty: it.qty, unit_liq: it.ad, unit_imp: it.an,
    img_cands: it.img_custom ? [it.img_custom] : candidatesFor(it.nome),
    frete_liq: idx===0 ? frete : 0, frete_imp: idx===0 ? frete : 0
  }));
  return { uf, km, data: new Date().toISOString(), itens };
}

btnCloseQuote.addEventListener('click', async ()=>{
  const dados = coletarDadosParaProposta();
  if(!dados.itens || dados.itens.length===0){
    alert('Selecione ao menos 1 item para gerar a proposta.'); return;
  }
  const querSeg = await confirmBR('Deseja adicionar célula de segurança?');
  if (querSeg) {
    const ok = await promptSenhaBR('Informe a senha para adicionar a célula de segurança:');
    if (ok) {
      const PRECO = {
        'SEÇÃO BIOMBO 1,2×2M': 2473.42,'BARREIRA DE LUZ 1,7M': 27207.60,'BARREIRA DE LUZ 1M': 18138.40,
        'SEMAFORO 4 CORES': 824.47,'FECHADURA SEGURANÇA/SENSOR': 10718.14,'BOTOEIRA BIMANUAL': 9069.20,
        'CLP PROGRAMAÇÃO': 15664.98,'CLP SEGURANÇA': 11377.72,'RELÊ DE SEGURANÇA': 3297.89,'CABEAMENTO/CONECTORES': 16489.45
      };
      const lista=[]; let base=0;
      for (const [nome, preco] of Object.entries(PRECO)) {
        const resp = prompt('Quantidade para '+nome+' (R$ '+preco.toFixed(2)+'):', '0');
        if (resp === null) continue;
        const q = Math.max(0, parseInt(String(resp).trim() || '0', 10));
        if (q > 0) { const sub=q*preco; lista.push({ nome, qtd:q, preco, subtotal:sub }); base += sub; }
      }
      if (base > 0) {
        const linhas = lista.map(it => it.qtd+'× '+it.nome);
        const descTexto = 'Componentes da célula de segurança:- '+linhas.join('- ');
        const ufSel = String(document.querySelector('#uf')?.value || 'PR').toUpperCase();
        const unit_liq = +(base * 1.45).toFixed(2);
        const unit_imp = +(unit_liq * (ufSel==='PR'?1.12245:1.0765)).toFixed(2);
        dados.itens.push({
          nome:'Célula de segurança', qty:1, unit_liq, unit_imp,
          img_cands:['imagens/CELULA DE SEGURANCA.png'],
          desc_default: descTexto, frete_liq:0, frete_imp:0
        });
        dados.celulaSeg = lista;
      }
    }
  }
  sessionStorage.setItem('propostaData', JSON.stringify(dados));
  window.location.href = 'proposta.html';
});

/* ===== Boot ===== */
(async function init(){ await loadDataByUF(state.uf); })();
</script>
</body>
</html>
