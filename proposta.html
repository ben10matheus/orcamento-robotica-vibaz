<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Proposta - VIBAZ</title>
<style>
  /* ====== ESTILO BASE ====== */
  @page { size: A4; margin: 0 12.7mm; }
  :root{ --ink:#0e1222; --frame:#000; --muted:#303a60; }
  html,body{ height:100%; margin:0; background:#dfe7ff; color:var(--ink); font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial }

  .page{ width:210mm; height:297mm; margin:20px auto; background:#fff; position:relative; box-sizing:border-box; border:none; box-shadow:0 8px 24px rgba(0,0,0,.08); overflow:hidden }
  @media screen{ .page{ border:2px solid #000; } }
  @media print{ body{ background:#fff } .page{ width: calc(210mm - 25.4mm); height:297mm; margin:0 auto; border:none; box-shadow:none } .no-print{ display:none !important } }

  .head,.rodapeimg{ border:none; padding:0 }
  .head img,.rodapeimg img{ width:100%; display:block; object-fit:contain }

  .title{ margin:0 0 2mm }
  .title h1{ margin:0; font-size:18px; letter-spacing:.2px }
  .title .meta{ color:var(--muted); font-size:12px; margin-top:2mm }

  .box{ border:1px solid var(--frame); border-radius:10px; padding:5mm; margin:3mm 0 0 }
  .box h3{ margin:0 0 3mm; font-size:14px }

  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:4mm }
  .grid-1{ display:grid; grid-template-columns:1fr; gap:4mm }
  label{ display:block; font-size:12px; margin-bottom:1mm }
  input{ width:100%; border:1px solid #dfe3ff; border-radius:8px; padding:7px 9px; background:#fbfcff; transform:scale(0.9); transform-origin:left center; display:inline-block; }
  .grid-2 input{ width:95%; box-sizing:border-box }

  .frase{ margin:5mm 0 0; font-size:13px }
  .strong{ font-weight:800 }

  .footer{ position:absolute; left:0; right:0; bottom:0 }
  .rodapeimg{ margin-top:3mm }
  .pageno{ position:absolute; right:2mm; bottom:2mm; font-size:12px }

  .sigs{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:3mm; margin-top:5mm }
  .sig{ border:1px solid #cfd7ff; border-radius:10px; padding:3mm; font-size:12px }
  .sig .nm{ font-weight:800 }

  .page-1{ padding:0 0 58mm 0 }
  .capa{ margin:6mm 0 5mm; display:flex; align-items:center; justify-content:center; min-height:70mm }
  .capa img{ max-width:100%; max-height:70mm; object-fit:contain; display:block }

  .page-2,.page-3,.page-4,.page-5,.page-6,.page-7,.page-8{ padding:0 0 40mm 0 }
  .sec-titulo,.sec-titulo-4,.sec-titulo-5,.sec-titulo-6,.sec-titulo-7,.sec-titulo-8{ font-weight:800; text-decoration:underline; margin:6mm 0 3mm }

  .writebox{ border:1px solid var(--frame); border-radius:10px; padding:5mm; margin:0; flex:1 1 auto; min-height:0; line-height:1.6; outline:none; }
  /* placeholder opcional via data-ph */
  .writebox:empty:before{ content: attr(data-ph); color:#9aa3c7 }

  /* Uploads (págs. 2 e 3) */
  .subttl{ font-weight:800; margin:0 0 2mm; font-size:14px }
  .uploadbox{ display:flex; flex-direction:column; gap:3mm; flex:1 1 auto; min-height:0 }
  .dropzone{ border:2px dashed #9aa3c7; border-radius:10px; padding:6mm; text-align:center; color:#647096; user-select:none; }
  .dropzone input[type="file"]{ display:none !important; }
  .dropzone .btn{ background:#44507c; color:#fff; border:1px solid #cfd7ff; border-radius:10px; padding:8px 12px; cursor:pointer }
  .dropzone .btn:hover{ background:#3b486f }
  .preview{ flex:1 1 auto; min-height:0; display:grid; grid-template-columns:1fr 1fr; gap:4mm; }
  .imgcard{ position:relative; border:1px solid #cfd7ff; border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#fff; break-inside:avoid; page-break-inside:avoid; }
  .imgcard img{ max-width:100%; max-height:100%; display:block; object-fit:contain }
  .imgremove{ position:absolute; top:6px; right:6px; background:#0008; color:#fff; border:none; border-radius:8px; padding:6px 8px; font-size:12px; cursor:pointer }
  @media print{ .dropzone,.imgremove{ display:none !important } .imgcard{ border:none } }

  /* Cards da Descrição (pág.4) */
  .itens{ display:flex; flex-direction:column; gap:4mm }
  .itemcard{ border:1px solid var(--frame); border-radius:10px; padding:4mm; display:grid; grid-template-columns:48mm 1fr; gap:4mm; align-items:start; break-inside:avoid; page-break-inside:avoid; }
  .itemimg{ width:100%; height:42mm; border:1px dashed #cfd7ff; border-radius:8px; display:flex; align-items:center; justify-content:center; background:#fff; overflow:hidden }
  .itemimg img{ max-width:100%; max-height:100%; object-fit:contain; display:block }
  .itemname{ font-weight:800; margin-bottom:2mm }
  .desc4{ min-height:28mm; margin-top:3mm }

  /* Tabela (pág. 5) */
  table.tbl5{ width:100%; border-collapse:separate; border-spacing:0; border:1px solid #000; border-radius:10px; overflow:hidden; margin-top:3mm }
  .tbl5 th,.tbl5 td{ border:1px solid #000; padding:6px 8px }
  .tbl5 th{ background:#eef2ff; text-align:left }
  .right{ text-align:right; font-variant-numeric:tabular-nums }
  .tot{ font-weight:800 }
  .tbl5 tr{ break-inside:avoid; page-break-inside:avoid }

  .no-print{ display:flex; justify-content:center; gap:8px; padding:12px 0 24px }
  .btn{ padding:10px 14px; border-radius:10px; border:1px solid #cfd7ff; background:#44507c; color:#fff; cursor:pointer }

  /* Páginas automáticas */
  .page-auto{ width:210mm; height:297mm; margin:20px auto; background:#fff; position:relative; box-sizing:border-box; border:none; box-shadow:0 8px 24px rgba(0,0,0,.08); }
  .page-auto .auto-body{ padding:0 0 40mm 0 }
  @media print{ .page-auto{ width: calc(210mm - 25.4mm); height:297mm; margin:0 auto; box-shadow:none; } }

  /* Ocultar excedente no original (clones não recebem a classe) */
  .has-auto .hide-when-auto{ display:none !important }

  /* Garantia (pág. 6) – estilo aplicado no original e nas páginas (cont.) */
  #pagina6 .itemcard, .page-6 .itemcard { display:block !important; border:none !important; margin-bottom:8px; }
  #pagina6 .itemname, .page-6 .itemname { white-space:nowrap; text-align:center; font-weight:800; font-size:14px; margin-bottom:4px; }
  #pagina6 .writebox, .page-6 .writebox { border:none !important; padding:0 !important; margin:0 auto !important; min-height:auto !important; font-size:13px; line-height:1.5; text-align:center; }

  /* Notas (pág. 3) */
  .note{ font-size:13px; line-height:1.45; margin-top:6mm }
  .note b{ font-weight:800 }
  @media print{ .frete-pop,.popup{ display:none !important } }
</style>
</head>
<body>

<!-- ==================== PÁGINA 1 ==================== -->
<section class="page page-1" id="pagina1">
  <div class="head"><img src="prop/cabecalho_prop.png" alt="Cabeçalho (3 logos)"></div>
  <div class="title">
    <div class="meta" id="dataHoje">Terça-feira, 30 de setembro de 2025 • Certificado ISO 9001:2015</div>
    <h1>PROPOSTA TÉCNICA COMERCIAL</h1>
  </div>

  <section class="box">
    <h3>DADOS DO CLIENTE</h3>
    <div class="grid-1"><div><label>Empresa</label><input id="cliEmpresa"></div></div>
    <div class="grid-1"><div><label>Contato</label><input id="cliContato"></div></div>
    <div class="grid-1"><div><label>E-mail</label><input id="cliEmail"></div></div>
    <div class="grid-1"><div><label>Orçamento</label><input id="cliOrc" placeholder="ex.: 2025-00123"></div></div>
    <div class="grid-2">
      <div><label>Telefone</label><input id="cliFone" maxlength="15"></div>
      <div><label>Cidade</label><input id="cliCidade"></div>
    </div>
    <div class="grid-1"><div><label>CNPJ</label><input id="cliCNPJ" maxlength="18" placeholder="00.000.000/0000-00"></div></div>
  </section>

  <div class="capa"><img src="prop/capa_prop.png" alt="Capa da proposta"></div>
  <section class="frase">
    A Vibaz agradece sua confiança e a oportunidade de apoiar sua necessidade.
    Esta proposta apresentará os detalhes técnicos e comerciais ofertados. Em caso de dúvidas,
    fale com nosso time comercial. <span class="strong">Departamento Comercial VIBAZ.</span>
  </section>

  <div class="sigs">
    <div class="sig"><div class="nm">Solange Bahri</div>Diretora Comercial<br>Cel.: 41 9 8829-6858<br>E-mail: Solange.b@vibaz.com.br</div>
    <div class="sig"><div class="nm">Max Borges Merizzio</div>Gerente Geral<br>Cel.: 41 9 9848-0830<br>E-mail: max.m@vibaz.com.br</div>
    <div class="sig"><div class="nm">Richard Maturana</div>Engenharia<br>Cel.: 41 9 9652-2237<br>E-mail: richard.m@vibaz.com.br</div>
  </div>

  <footer class="footer"><div class="rodapeimg"><img src="prop/rodape_prop.png" alt="Rodapé da proposta"></div><div class="pageno"></div></footer>
</section>

<!-- Pop-up de CNPJ inválido -->
<div id="cnpjPop" class="popup" hidden>
  <div class="popup__box">
    <h3>CNPJ inválido</h3>
    <p>O número informado não corresponde a um CNPJ válido.</p>
    <button id="cnpjOk" class="btn">Ok</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){
  function maskCNPJ(v){
    v = v.replace(/\D/g,"");
    if(v.length <= 14){
      v = v.replace(/^(\d{2})(\d)/,"$1.$2");
      v = v.replace(/^(\d{2})\.(\d{3})(\d)/,"$1.$2.$3");
      v = v.replace(/\.(\d{3})(\d)/,".$1/$2");
      v = v.replace(/(\d{4})(\d)/,"$1-$2");
    }
    return v;
  }
  function maskPhone(v){
    v = v.replace(/\D/g,"");
    return (v.length > 10)
      ? v.replace(/^(\d{2})(\d{5})(\d{4}).*/,"($1) $2-$3")
      : v.replace(/^(\d{2})(\d{4})(\d{4}).*/,"($1) $2-$3");
  }
  const cnpjInput=document.getElementById('cliCNPJ');
  const telInput=document.getElementById('cliFone');
  const pop=document.getElementById('cnpjPop');
  const ok=document.getElementById('cnpjOk');

  if(telInput){ telInput.addEventListener('blur', ()=>{ if(telInput.value) telInput.value = maskPhone(telInput.value); }); }
  if(cnpjInput){
    cnpjInput.addEventListener('blur',()=>{
      if(cnpjInput.value){
        cnpjInput.value = maskCNPJ(cnpjInput.value);
        if(!validarCNPJ(cnpjInput.value)) pop.hidden=false;
      }
    });
  }
  if(ok){ ok.addEventListener('click',()=>pop.hidden=true); }
  if(pop){ pop.addEventListener('click',e=>{ if(e.target===pop) pop.hidden=true; }); }

  function validarCNPJ(cnpj){
    cnpj = cnpj.replace(/[^\d]+/g,'');
    if(cnpj.length!==14) return false;
    if(/^(.)\1+$/.test(cnpj)) return false;
    let t=cnpj.length-2, n=cnpj.substring(0,t), d=cnpj.substring(t), s=0, p=t-7;
    for(let i=t;i>=1;i--){ s+=n.charAt(t-i)*p--; if(p<2)p=9 }
    let r=s%11<2?0:11-s%11; if(r!=d.charAt(0))return false;
    t++; n=cnpj.substring(0,t); s=0; p=t-7;
    for(let i=t;i>=1;i--){ s+=n.charAt(t-i)*p--; if(p<2)p=9 }
    r=s%11<2?0:11-s%11; return r==d.charAt(1);
  }
});
</script>

<!-- ==================== PÁGINA 2 ==================== -->
<section class="page page-2" id="pagina2">
  <div class="head"><img src="prop/cabecalho_prop.png" alt="Cabeçalho (3 logos)"></div>
  <h2 class="sec-titulo">Descrição da necessidade</h2>

  <!-- Campo de texto da página 2 -->
  <div id="editBox2" class="writebox" contenteditable="true"
       data-ph="Descreva aqui a necessidade (opcional)..."></div>

  <div class="uploadbox" style="margin-top:6mm">
    <div class="subttl">Imagens </div>
    <div id="drop" class="dropzone">
      <input id="fileInput" type="file" accept="image/*" multiple>
      <p><button type="button" class="btn pick">Escolher arquivos</button></p>
      <p>Arraste e solte aqui ou clique para enviar</p>
      <p style="font-size:12px; margin-top:2mm">Formatos: PNG/JPG • Até 4 imagens</p>
    </div>
    <div id="preview" class="preview"></div>
  </div>

  <footer class="footer">
    <div class="rodapeimg"><img src="prop/rodape_prop.png" alt="Rodapé da proposta"></div>
    <div class="pageno"></div>
  </footer>
</section>

<!-- ==================== PÁGINA 3 ==================== -->
<section class="page page-3" id="pagina3">
  <div class="head"><img src="prop/cabecalho_prop.png" alt="Cabeçalho (3 logos)"></div>
  <h2 class="sec-titulo">Solução proposta</h2>

  <div id="editBox3" class="writebox" contenteditable="true"
       data-ph="Explique a solução proposta..."></div>

  <div class="uploadbox" style="margin-top:6mm">
    <div class="subttl">Imagens </div>
    <div id="drop3" class="dropzone">
      <input id="fileInput3" type="file" accept="image/*" multiple>
      <p><button type="button" class="btn pick3">Escolher arquivos</button></p>
      <p>Arraste e solte aqui ou clique para enviar</p>
      <p style="font-size:12px; margin-top:2mm">Formatos: PNG/JPG • Até 4 imagens</p>
    </div>
    <div id="preview3" class="preview"></div>
  </div>

  <div class="note note3">
    <b>Importante:</b>
    Esta é uma proposta inicial; em caso de intenção de compra por parte do cliente, será iniciado o projeto final,
    podendo haver alterações de equipamentos e preços a depender das necessidades e especificidades — alterações estas
    que estarão passíveis de aprovação do cliente.
  </div>

  <footer class="footer">
    <div class="rodapeimg"><img src="prop/rodape_prop.png" alt="Rodapé da proposta"></div>
    <div class="pageno"></div>
  </footer>
</section>

<!-- ==================== PÁGINA 4 ==================== -->
<section class="page page-4" id="pagina4">
  <div class="head"><img src="prop/cabecalho_prop.png" alt="Cabeçalho (3 logos)"></div>
  <h2 class="sec-titulo-4">Descrição</h2>
  <div id="itensLista" class="itens"></div>
  <footer class="footer">
    <div class="rodapeimg"><img src="prop/rodape_prop.png" alt="Rodapé da proposta"></div>
    <div class="pageno"></div>
  </footer>
</section>

<!-- ==================== PÁGINA 5 – Itens e investimento ==================== -->
<section class="page page-5" id="pagina5">
  <div class="head"><img src="prop/cabecalho_prop.png" alt="Cabeçalho (3 logos)"></div>
  <h2 class="sec-titulo-5">Itens e investimento</h2>

  <table class="tbl5" id="tbl5">
    <thead>
      <tr>
        <th style="width:58%">Produto</th>
        <th>Qtd</th>
        <th class="right">Unit. (líquido)</th>
        <th class="right">Unit. (c/ impostos)</th>
      </tr>
    </thead>
    <tbody id="tbody5"></tbody>
    <tfoot>
      <tr><td colspan="4" class="right tot" id="subLiq5">Subtotal valor líquido</td></tr>
      <tr><td colspan="4" class="right tot" id="subImp5">Subtotal valor c/ impostos</td></tr>
      <tr><td colspan="4" class="right tot" id="totGeral5">Total geral</td></tr>
    </tfoot>
  </table>

  <div class="grid-2" style="margin-top:4mm">
    <section class="box">
      <h3>Impostos da venda</h3>
      <div id="imp5">NCM: 85159000 – IPI 0%. PIS 0,65% / COFINS 3%. ICMS — conforme UF do cliente.</div>
    </section>
    <section class="box">
      <h3>Condições comerciais</h3>
      <div style="line-height:1.45">
        <b>Forma de pagamento:</b> <span id="formaPagamentoSpan">a negociar no fechamento do pedido.</span>
        <button id="btnMudarPagamento" class="no-print btn" style="margin-left:10px; padding:6px 8px; font-size:12px;">Mudar forma de pagamento</button>
        <br>
        <b>Prazo de entrega previsto:</b> Importação: estimativa 75 dias após confirmação. Estoque: 2 dias úteis para preparação.<br>
        <b>Transporte e seguro:</b> por conta do cliente (Retirar VIBAZ – PR).<br>
        <b>Validade da proposta:</b> até <span id="validadeData"></span>.
      </div>
    </section>
  </div>

  <footer class="footer">
    <div class="rodapeimg"><img src="prop/rodape_prop.png" alt="Rodapé da proposta"></div>
    <div class="pageno"></div>
  </footer>
</section>

<!-- ==================== PÁGINA 6 – Qualidade Assegurada vs Garantia ==================== -->
<section class="page page-6" id="pagina6">
  <div class="head"><img src="prop/cabecalho_prop.png" alt="Cabeçalho (3 logos)"></div>
  <h2 class="sec-titulo-6">Qualidade Assegurada versus Garantia</h2>
  <div class="garantia">
    <p>Este descritivo detalha os termos e condições da garantia oferecida para os equipamentos; nosso compromisso é fornecer equipamentos de alta qualidade e assegurar a satisfação de nossos clientes.</p>
    <p>Contempla-se a garantia de <b>12 meses</b>, a partir da <b>entrega via nota fiscal</b>.</p>
    <p>Esta garantia cobre <b>defeitos de fabricação</b>.</p>
    <p>Os seguintes componentes são cobertos por esta garantia:</p>
    <div id="descPag6Lista" class="itens"></div>
  </div>
  <footer class="footer">
    <div class="rodapeimg"><img src="prop/rodape_prop.png" alt="Rodapé da proposta"></div>
    <div class="pageno"></div>
  </footer>
</section>

<!-- ==================== PÁGINA 7 – Exclusões da Garantia ==================== -->
<section class="page page-7" id="pagina7">
  <div class="head"><img src="prop/cabecalho_prop.png" alt="Cabeçalho (3 logos)"></div>
  <h2 class="sec-titulo-7">Exclusões da Garantia:</h2>
  <div class="guia">
    <p>Esta garantia não cobre os seguintes:</p>
    <ul>
      <li>Desgaste normal devido ao uso, componentes de desgaste natural.</li>
      <li>Danos por mau uso, operação incorreta, negligência, acidentes, ou uso para fins não previstos.</li>
      <li>Manutenção inadequada ou uso de peças não originais/recomendadas.</li>
      <li>Alterações/modificações não autorizadas.</li>
      <li>Eventos externos (raios, inundações, incêndios, etc.).</li>
      <li>Variação de tensão elétrica.</li>
      <li>Tempo de inatividade/perdas financeiras decorrentes.</li>
    </ul>
    <h3 class="sec-titulo">Observação:</h3>
    <p>A garantia não abrange consumíveis de solda e peças de desgaste; custos de deslocamento/alojamento do técnico por conta do cliente.</p>
  </div>
  <footer class="footer">
    <div class="rodapeimg"><img src="prop/rodape_prop.png" alt="Rodapé da proposta"></div>
    <div class="pageno"></div>
  </footer>
</section>

<!-- ==================== PÁGINA 8 – Serviços ==================== -->
<section class="page page-8" id="pagina8">
  <div class="head"><img src="prop/cabecalho_prop.png" alt="Cabeçalho (3 logos)"></div>
  <h2 class="sec-titulo-8">Serviços</h2>
  <div class="srv">
    <h3>Treinamento</h3>
    <p>Incluso na proposta: treinamento de programação no startup dos equipamentos, composto por <b>16 horas</b> divididas em até <b>03 dias</b> para <b>03 participantes</b>.</p>
    <ul>
      <li><b>Na Matriz VIBAZ – PR</b>: viagem/hospedagem/alimentação dos participantes por conta do cliente.</li>
      <li><b>No cliente</b>: viagem/hospedagem/alimentação do técnico por conta do cliente.</li>
    </ul>
    <h3>Programação</h3>
    <p>Serviço de programação pode ser contratado à parte.</p>
    <p class="atenc">Atenciosamente, departamento comercial VIBAZ.</p>
    <div class="sigs">
      <div class="sig"><div class="nm">Solange Bahri</div>Diretora Comercial<br> Cel.: 41 9 8829-6858<br>E-mail: Solange.b@vibaz.com.br</div>
      <div class="sig"><div class="nm">Max Borges Merizzio</div>Gerente Geral<br> Cel.: 41 9 9848-0830<br>E-mail: max.m@vibaz.com.br</div>
      <div class="sig"><div class="nm">Richard Maturana</div>Engenharia<br> Cel.: 41 9 9652-2237<br>E-mail: richard.m@vibaz.com.br</div>
    </div>
  </div>
  <footer class="footer">
    <div class="rodapeimg"><img src="prop/rodape_prop.png" alt="Rodapé da proposta"></div>
    <div class="pageno"></div>
  </footer>
</section>

<div class="no-print" style="margin-top:12px"><button id="btnPrintAll" class="btn">Imprimir proposta</button></div>

<div id="fretePop" class="frete-pop no-print" hidden>
  <div class="frete-pop__box">
    <h3>Frete embutido</h3>
    <p>Será adicionado <b id="freteValor"></b> referente a <b id="freteKM"></b> km (R$ 1,60/km) ao <b>1º item</b>, nos valores <b>líquido</b> e <b>c/ impostos</b>.</p>
    <div style="text-align:right; margin-top:6px"><button id="freteOk" class="btn">Ok</button></div>
  </div>
</div>

<!-- ====== POPUPS (senha + editor de forma de pagamento) ====== -->
<div id="pwdPop" class="popup" hidden>
  <div class="popup__box">
    <h3>Digite a senha para alteração da forma de pagamento</h3>
    <input id="pwdInput" type="password" placeholder="Senha" style="width:100%;padding:8px 10px;border:1px solid #cfd7ff;border-radius:8px">
    <div id="pwdErr" style="display:none;color:#b91c1c;font-size:12px;margin-top:6px">Senha incorreta. Tente novamente.</div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="pwdCancel" class="btn">Cancelar</button>
      <button id="pwdOk" class="btn">Confirmar</button>
    </div>
  </div>
</div>

<div id="fpEditPop" class="popup" hidden>
  <div class="popup__box">
    <h3>Editar forma de pagamento</h3>
    <textarea id="fpEditText" style="width:100%;min-height:120px;padding:8px 10px;border:1px solid #cfd7ff;border-radius:8px"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="fpReset" class="btn" title="Voltar ao padrão">Padrão</button>
      <button id="fpCancel" class="btn">Cancelar</button>
      <button id="fpOk" class="btn">Salvar</button>
    </div>
  </div>
</div>

<script>
const money = v => isFinite(v) ? v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : '-';
function updateDocTitle(){
  const orc = (document.getElementById('cliOrc')?.value || '').trim();
  document.title = orc ? `Proposta ${orc} - VIBAZ` : 'Proposta - VIBAZ';
}
/* Data pág.1 */
(function(){
  const hoje=new Date();
  const dias=['Domingo','Segunda-feira','Terça-feira','Quarta-feira','Quinta-feira','Sexta-feira','Sábado'];
  const meses=['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
  const el=document.getElementById('dataHoje');
  if(el){ el.textContent = `${dias[hoje.getDay()]}, ${String(hoje.getDate()).padStart(2,'0')} de ${meses[hoje.getMonth()]} de ${hoje.getFullYear()} • Certificado ISO 9001:2015`; }
})();
/* Título auto */
(function(){
  const orc = document.getElementById('cliOrc');
  if(orc){ updateDocTitle(); orc.addEventListener('input', updateDocTitle); }
  window.addEventListener('beforeprint', updateDocTitle);
})();
</script>

<!-- Uploads págs. 2 e 3 -->
<script>
(function(){
  const MAX = 4;
  const dz=document.getElementById('drop'), input=document.getElementById('fileInput'), preview=document.getElementById('preview');
  if(!dz||!input||!preview) return; let images=[];
  dz.querySelector('.pick').addEventListener('click', e=>{ e.preventDefault(); input.click(); });
  function render(){
    preview.innerHTML='';
    images.forEach((src,idx)=>{
      const card=document.createElement('div'); card.className='imgcard';
      const img=new Image(); img.src=src; card.appendChild(img);
      const rm=document.createElement('button'); rm.className='imgremove'; rm.textContent='remover';
      rm.onclick=()=>{ images.splice(idx,1); render(); document.dispatchEvent(new Event('images-changed')); };
      card.appendChild(rm); preview.appendChild(card);
    });
    document.dispatchEvent(new Event('images-changed'));
  }
  function add(list){
    const files=[...list].filter(f=>/^image\//.test(f.type));
    const space=MAX-images.length; if(space<=0){ alert(`Máximo de ${MAX} imagens.`); return; }
    files.slice(0,space).forEach(f=>{
      const r=new FileReader(); r.onload=e=>{ images.push(e.target.result); render(); }; r.readAsDataURL(f);
    });
  }
  dz.addEventListener('click',()=>input.click());
  dz.addEventListener('dragover',e=>{ e.preventDefault(); });
  dz.addEventListener('drop',e=>{ e.preventDefault(); add(e.dataTransfer.files); });
  input.addEventListener('change',()=> add(input.files));
})();

(function(){
  const MAX = 4;
  const dz=document.getElementById('drop3'), input=document.getElementById('fileInput3'), preview=document.getElementById('preview3');
  if(!dz||!input||!preview) return; let images=[];
  dz.querySelector('.pick3').addEventListener('click', e=>{ e.preventDefault(); input.click(); });
  function render(){
    preview.innerHTML='';
    images.forEach((src,idx)=>{
      const card=document.createElement('div'); card.className='imgcard';
      const img=new Image(); img.src=src; card.appendChild(img);
      const rm=document.createElement('button'); rm.className='imgremove'; rm.textContent='remover';
      rm.onclick=()=>{ images.splice(idx,1); render(); document.dispatchEvent(new Event('images-changed')); };
      card.appendChild(rm); preview.appendChild(card);
    });
    document.dispatchEvent(new Event('images-changed'));
  }
  function add(list){
    const files=[...list].filter(f=>/^image\//.test(f.type));
    const space=MAX-images.length; if(space<=0){ alert(`Máximo de ${MAX} imagens.`); return; }
    files.slice(0,space).forEach(f=>{
      const r=new FileReader(); r.onload=e=>{ images.push(e.target.result); render(); }; r.readAsDataURL(f);
    });
  }
  dz.addEventListener('click',()=>input.click());
  dz.addEventListener('dragover',e=>{ e.preventDefault(); });
  dz.addEventListener('drop',e=>{ e.preventDefault(); add(e.dataTransfer.files); });
  input.addEventListener('change',()=> add(input.files));
})();
</script>

<!-- Helpers de imagem + montagem dos cards (pág.4) -->
<script>
function candidatesFor(nome){
  const raw=String(nome||'').trim();
  const noAcc=raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  const cleaned=noAcc.replace(/[+]/g,'_').replace(/[^\w.\- ]+/g,'_').replace(/_/g,' ').replace(/\s+/g,' ').trim();
  const u=cleaned.replace(/\s+/g,'_'), h=cleaned.replace(/\s+/g,'-');
  const bases=[raw,noAcc,cleaned,u,h,raw.toUpperCase(),noAcc.toUpperCase(),cleaned.toUpperCase(),u.toUpperCase(),h.toUpperCase(),raw.toLowerCase(),noAcc.toLowerCase(),cleaned.toLowerCase(),u.toLowerCase(),h.toLowerCase()].filter((v,i,a)=>v&&a.indexOf(v)===i);
  const out=[]; for(const b of bases){ out.push(`imagens/${b}.png`,`imagens/${b}.jpg`,`imagens/${b}.jpeg`); } return out;
}
function loadWithFallback(img,list,i=0){
  if(!list||!list.length){ img.style.display='none'; return; }
  if(i>=list.length){ img.style.display='none'; return; }
  img.onerror=()=>loadWithFallback(img,list,i+1);
  img.onload=()=>{ img.style.display='block'; };
  img.src=list[i];
}

(function(){
  const cont=document.getElementById('itensLista'); if(!cont) return;
  const raw=sessionStorage.getItem('propostaData'); const data=raw?JSON.parse(raw):{}; const itens=Array.isArray(data.itens)?data.itens:[];
  if(itens.length===0){
    const e=document.createElement('div'); e.className='writebox'; e.style.borderStyle='dashed'; e.textContent='Nenhum item encontrado.'; cont.appendChild(e); return;
  }
  itens.forEach((it,idx)=>{
    const card=document.createElement('div'); card.className='itemcard'; card.setAttribute('data-idx', idx);
    const imgWrap=document.createElement('div'); imgWrap.className='itemimg';
    const img=new Image(); img.alt=it?.nome||'Item'; imgWrap.appendChild(img);
    const list=Array.isArray(it.img_cands)&&it.img_cands.length?it.img_cands:candidatesFor(it?.nome);
    loadWithFallback(img,list);
    const info=document.createElement('div');
    const name=document.createElement('div'); name.className='itemname'; name.textContent=it?.nome||'Item sem nome';
    const desc=document.createElement('div'); desc.className='writebox desc4'; desc.contentEditable='true'; desc.spellcheck=false;
    if(it && typeof it.desc_default==='string' && it.desc_default.trim().length){ desc.innerHTML=it.desc_default.replace(/\n/g,'<br>'); }
    info.append(name,desc); card.append(imgWrap,info); cont.appendChild(card);
  });
})();
</script>

<!-- Página 5 — cálculos -->
<script>
(function(){
  const raw=sessionStorage.getItem('propostaData'); const data=raw?JSON.parse(raw):{};
  const uf=String(data.uf||'PR').toUpperCase();
  const itens=Array.isArray(data.itens)?data.itens:[];
  const tbody=document.getElementById('tbody5'); if(!tbody) return;

  let subLiq=0, subImp=0;
  itens.forEach((it,idx)=>{
    let unitLiq=+it.unit_liq||0, unitImp=+it.unit_imp||0, qty=Math.max(1,+it.qty||1);
    if((it.nome||'').toLowerCase()==='célula de segurança' && Math.abs(unitImp-unitLiq)<0.01){
      unitImp=+(unitLiq*((uf==='PR')?1.12245:1.0765)).toFixed(2);
    }
    const freteLiq=idx===0? +it.frete_liq||0 : 0, freteImp=idx===0? +it.frete_imp||0 : 0;
    subLiq+=unitLiq*qty+freteLiq; subImp+=unitImp*qty+freteImp;
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.nome||'-'}</td><td class="right">${qty}</td><td class="right">${money(unitLiq)}</td><td class="right">${money(unitImp)}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('subLiq5').textContent='Subtotal valor líquido   '+money(subLiq);
  document.getElementById('subImp5').textContent='Subtotal valor c/ impostos   '+money(subImp);
  document.getElementById('totGeral5').textContent='Total geral   '+money(subImp);

  const imp=document.getElementById('imp5');
  imp.textContent=(uf==='PR')
    ? 'NCM: 85159000 – IPI 0%. PIS 0,65% / COFINS 3%. ICMS – 8,0% (vendas dentro do estado do PR).'
    : 'NCM: 85159000 – IPI 0%. PIS 0,65% / COFINS 3%. ICMS – 4,0% (vendas fora do estado do PR).';

  const vd=document.getElementById('validadeData');
  if(vd){ const base=data?.data?new Date(data.data):new Date(); const ate=new Date(base); ate.setDate(base.getDate()+7); vd.textContent=ate.toLocaleDateString('pt-BR'); }
})();
</script>

<!-- Frete (popup) -->
<script>
(function(){
  const raw=sessionStorage.getItem('propostaData'); const data=raw?JSON.parse(raw):{};
  const km=+data.km||0, itens=Array.isArray(data.itens)?data.itens:[];
  if(!km||!itens.length) return;
  const frete=+(itens[0]?.frete_liq||0); if(!frete) return;
  const pop=document.getElementById('fretePop'), v=document.getElementById('freteValor'), k=document.getElementById('freteKM'), ok=document.getElementById('freteOk');
  v.textContent=money(frete); k.textContent=km.toLocaleString('pt-BR'); pop.hidden=false;
  ok.addEventListener('click',()=>pop.hidden=true); pop.addEventListener('click',e=>{ if(e.target===pop) pop.hidden=true; });
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') pop.hidden=true; });
})();
</script>

<!-- Senha + editor forma de pagamento -->
<script>
(function(){
  const PASSWORD='121419', DEFAULT_TEXT='a negociar no fechamento do pedido.';
  const btn=document.getElementById('btnMudarPagamento'), span=document.getElementById('formaPagamentoSpan');
  const pwdPop=document.getElementById('pwdPop'), pwdInput=document.getElementById('pwdInput'), pwdErr=document.getElementById('pwdErr'), pwdOk=document.getElementById('pwdOk'), pwdCancel=document.getElementById('pwdCancel');
  const editPop=document.getElementById('fpEditPop'), editText=document.getElementById('fpEditText'), editOk=document.getElementById('fpOk'), editCancel=document.getElementById('fpCancel'), editReset=document.getElementById('fpReset');
  if(!btn||!span) return;
  function open(el){ el.hidden=false; setTimeout(()=>el.querySelector('input,textarea,button')?.focus(),0); }
  function close(el){ el.hidden=true; }

  btn.addEventListener('click',()=>{ pwdErr.style.display='none'; pwdInput.value=''; open(pwdPop); });
  function submitPwd(){ if((pwdInput.value||'').trim()===PASSWORD){ close(pwdPop); editText.value=span.textContent.trim(); open(editPop); } else { pwdErr.style.display='block'; pwdInput.select(); } }
  pwdOk.addEventListener('click',submitPwd); pwdInput.addEventListener('keydown',e=>{ if(e.key==='Enter') submitPwd(); });
  pwdCancel.addEventListener('click',()=>close(pwdPop)); pwdPop.addEventListener('click',e=>{ if(e.target===pwdPop) close(pwdPop); });
  editCancel.addEventListener('click',()=>close(editPop)); editPop.addEventListener('click',e=>{ if(e.target===editPop) close(editPop); });
  document.addEventListener('keydown',e=>{ if(e.key==='Escape'){ if(!pwdPop.hidden) close(pwdPop); if(!editPop.hidden) close(editPop); }});
  editOk.addEventListener('click',()=>{ const txt=(editText.value||'').trim(); span.textContent=txt?txt:DEFAULT_TEXT; close(editPop); });
  editReset.addEventListener('click',()=>{ editText.value=DEFAULT_TEXT; editText.focus(); });
})();
</script>

<!-- ==================== AUTO PAGINAÇÃO + AJUSTE DINÂMICO DAS IMAGENS ==================== -->
<script>
(function(){
  let isRebuilding=false, isEditing=false, t=null;

  function removeAutoPages(){
    document.querySelectorAll('.page-auto').forEach(p=>p.remove());
    document.body.classList.remove('has-auto');
    document.querySelectorAll('.hide-when-auto').forEach(el=>el.classList.remove('hide-when-auto'));
  }
  function createAutoAfter(originalPage, titleText, titleClass){
    const page=document.createElement('section');
    page.className=`${originalPage.className} page-auto`;
    const head=originalPage.querySelector('.head')?.outerHTML||'';
    const rod =originalPage.querySelector('.rodapeimg')?.outerHTML||'';
    page.innerHTML=head+(titleText?`<h2 class="${titleClass||'sec-titulo'}">${titleText}</h2>`:'')+
      `<div class="auto-body"></div>`+
      `<footer class="footer">${rod}<div class="pageno"></div></footer>`;
    let anchor=originalPage;
    while(anchor.nextElementSibling && anchor.nextElementSibling.classList.contains('page-auto')) anchor=anchor.nextElementSibling;
    anchor.after(page);
    return page.querySelector('.auto-body');
  }
  function paginateByCount(originalPageSel, containerSel, title, titleClass, perPage, wrapClass, onClone){
    const page=document.querySelector(originalPageSel);
    const cont=document.querySelector(containerSel);
    if(!page||!cont) return;
    const items=[...cont.children].filter(n=>n.nodeType===1);
    items.forEach((el,idx)=> el.setAttribute('data-idx', idx));

    if(items.length<=perPage) return;

    document.body.classList.add('has-auto');
    items.forEach((el,idx)=>{ if(idx>=perPage) el.classList.add('hide-when-auto'); });

    for(let i=perPage;i<items.length;i+=perPage){
      const group=items.slice(i,i+perPage).map(n=>{
        const c=n.cloneNode(true);
        c.classList.remove('hide-when-auto');
        c.querySelectorAll?.('.hide-when-auto').forEach(x=>x.classList.remove('hide-when-auto'));
        if(typeof onClone==='function') onClone(c,n);
        return c;
      });
      if(!group.length) continue;
      const body=createAutoAfter(page, title, titleClass);
      const wrap=document.createElement('div');
      wrap.className=wrapClass || cont.className || '';
      group.forEach(el=>wrap.appendChild(el));
      body.appendChild(wrap);
    }
  }
  function paginateTableRows(originalPageSel, tableSel, title, titleClass, rowsPerPage=16){
    const page=document.querySelector(originalPageSel), tbl=document.querySelector(tableSel);
    if(!page||!tbl) return;
    const rows=[...tbl.querySelectorAll('tbody tr')];
    if(rows.length<=rowsPerPage) return;

    document.body.classList.add('has-auto');
    rows.forEach((r,i)=>{ if(i>=rowsPerPage) r.classList.add('hide-when-auto'); });

    const thead=tbl.querySelector('thead')?.outerHTML||'', tfoot=tbl.querySelector('tfoot')?.outerHTML||'';
    for(let i=rowsPerPage;i<rows.length;i+=rowsPerPage){
      const group=rows.slice(i,i+rowsPerPage).map(r=>{ const c=r.cloneNode(true); c.classList.remove('hide-when-auto'); return c; });
      if(!group.length) continue;
      const body=createAutoAfter(page, title, titleClass);
      const t=document.createElement('table'); t.className='tbl5'; t.innerHTML=thead+'<tbody></tbody>';
      const tb=t.querySelector('tbody'); group.forEach(r=>tb.appendChild(r));
      if(i+rowsPerPage>=rows.length) t.insertAdjacentHTML('beforeend', tfoot);
      body.appendChild(t);
    }
  }
  function renumber(){
    const all=[...document.querySelectorAll('.page, .page-auto')];
    const total=all.length;
    all.forEach((p,i)=>{ const spot=p.querySelector('.pageno'); if(spot) spot.textContent=`Página ${i+1} de ${total}`; });
  }

  /* ==== AJUSTE DINÂMICO DAS IMAGENS (págs. 2 e 3) ==== */
  function resizeAllPreviews(){
    document.querySelectorAll('.page-2 .preview, .page-3 .preview').forEach(preview=>{
      const page = preview.closest('.page');
      if(!page) return;
      const cards = preview.querySelectorAll('.imgcard');
      const n = cards.length;
      if(!n) return;

      const rectPage = page.getBoundingClientRect();
      const rectPrev = preview.getBoundingClientRect();
      const pb = parseFloat(getComputedStyle(page).paddingBottom)||0;
      const gap = parseFloat(getComputedStyle(preview).gap)||0;

      /* altura de blocos abaixo do preview (nota só na página 3 original) */
      let belowH = 0;
      const note = page.querySelector('.note3');
      if(note) belowH = note.getBoundingClientRect().height;

      const usedAbove = rectPrev.top - rectPage.top;
      const available = page.clientHeight - pb - usedAbove - belowH - 12; /* margem */

      const cols = 2;
      const rows = Math.ceil(n/cols);
      const per = Math.max(60, (available - gap*(rows-1))/rows); /* px mínimos por card */

      cards.forEach(c => c.style.height = per + 'px');
    });
  }

  function buildGuaranteeFromDescription(){
    const target=document.getElementById('descPag6Lista'); if(!target) return;
    target.innerHTML='';
    const nodes=[...document.querySelectorAll('#pagina4 #itensLista > .itemcard')];
    nodes.forEach(card=>{
      const title=card.querySelector('.itemname')?.textContent || 'Item sem nome';
      const desc =card.querySelector('.desc4')?.innerHTML || '&nbsp;';
      const wrap=document.createElement('div'); wrap.className='itemcard';
      const inner=document.createElement('div'); inner.style.display='flex'; inner.style.flexDirection='column';
      const name=document.createElement('div'); name.className='itemname'; name.textContent=title;
      const box =document.createElement('div'); box.className='writebox'; box.innerHTML=desc;
      inner.append(name,box); wrap.appendChild(inner); target.appendChild(wrap);
    });
  }

  function schedule(){ clearTimeout(t); t=setTimeout(build,250); }
  function build(){
    if(isEditing) return;
    isRebuilding=true;
    removeAutoPages();

    /* Descrição (pág. 4) – 3 por página */
    paginateByCount('#pagina4','#itensLista','Descrição','sec-titulo-4',3,'itens auto-desc',(clone,source)=>{
      const idx=source.getAttribute('data-idx');
      const d=clone.querySelector('.desc4');
      if(d){ d.setAttribute('data-src-idx', idx); d.contentEditable='true'; d.spellcheck=false; }
    });

    /* Garantia (pág. 6) – espelha descrição e também 3 por página */
    buildGuaranteeFromDescription();
    paginateByCount('#pagina6','#descPag6Lista','Qualidade Assegurada versus Garantia','sec-titulo-6',3,'itens auto-garantia');

    /* Imagens – 4 por página */
    paginateByCount('#pagina2','#preview','Descrição da necessidade — imagens','sec-titulo',4,'preview');
    paginateByCount('#pagina3','#preview3','Solução proposta — imagens','sec-titulo',4,'preview');

    /* Tabela (pág. 5): por linhas */
    paginateTableRows('#pagina5','#tbl5','Itens e investimento','sec-titulo-5',16);

    /* Numeração e ajuste de imagens */
    renumber();
    resizeAllPreviews();

    isRebuilding=false;
  }

  /* Observadores */
  ['#itensLista','#preview','#preview3','#tbody5','#descPag6Lista'].forEach(sel=>{
    const el=document.querySelector(sel); if(!el) return;
    new MutationObserver(()=>{ if(!isRebuilding && !isEditing) schedule(); }).observe(el,{childList:true,subtree:false});
  });

  /* Edição estável em clones (sincroniza no original) */
  document.addEventListener('focusin', e=>{
    if(e.target && e.target.classList && e.target.classList.contains('desc4')) isEditing=true;
  });
  document.addEventListener('input', e=>{
    const t=e.target;
    if(isRebuilding) return;
    if(t && t.classList && t.classList.contains('desc4')){
      const idx=t.getAttribute('data-src-idx');
      if(idx!=null){
        const orig=document.querySelector(`#itensLista > .itemcard[data-idx="${idx}"] .desc4`);
        if(orig) orig.innerHTML=t.innerHTML;
      }
    }
  });
  document.addEventListener('focusout', e=>{
    if(e.target && e.target.classList && e.target.classList.contains('desc4')){
      isEditing=false; schedule();
    }
  });
  document.addEventListener('keydown', e=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); if(!isEditing) build(); }
  });

  /* Recalcular grid de imagens quando digitar nas páginas 2 e 3 */
  document.getElementById('editBox2')?.addEventListener('input', resizeAllPreviews);
  document.getElementById('editBox3')?.addEventListener('input', resizeAllPreviews);

  window.addEventListener('load', ()=>{ build(); resizeAllPreviews(); });
  window.addEventListener('beforeprint', ()=>{ if(!isEditing){ build(); resizeAllPreviews(); } });
  window.addEventListener('resize', ()=>{ if(!isEditing) resizeAllPreviews(); });
  document.addEventListener('images-changed', ()=>{ if(!isEditing && !isRebuilding){ schedule(); } });
})();
</script>

<script>
/* Botão imprimir garante título atualizado */
document.getElementById('btnPrintAll')?.addEventListener('click', ()=>{ updateDocTitle(); setTimeout(()=>window.print(), 10); });
</script>
</body>
</html>
