<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vibaz Robótica — Catálogo</title>

<style>
  :root{
    --bg:#dfe7ff;          /* fundo da página (azul claro) */
    --panel:#333e63;       /* cabeçalho/toolbar */
    --card:#3a4266;        /* área de dados do cartão */
    --ink:#0e1222;
    --ink-inv:#ffffff;
    --brand:#6793ff;       /* tom principal (botões/moldura) */
    --line:#2b314a;
    --media-bg:#ffffff;    /* fundo da imagem do card */
    --media-frame:#333e63; /* moldura do card */
    --btn:#6e95ff;
    --btn-hover:#587ef0;
    --black:#000;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    position:relative;
  }
  /* LOGO DE FUNDO — fixa com 30% de opacidade */
  body::after{
    content:"";
    position:fixed;
    inset:0;
    background:
      url("imagens/logo.png")
      no-repeat
      center calc(100% - 40px) / clamp(240px, 40vw, 520px);
    opacity:.30;               /* ~30% */
    pointer-events:none;
    z-index:0;
  }

  header{
    position:sticky;
    top:0;
    z-index:20;
    background:var(--panel);
    border-bottom:1px solid var(--line);
  }
  header .wrap{
    max-width:1280px;
    margin:auto;
    padding:10px 16px;
    display:flex;
    align-items:center;
    gap:12px;
  }
  .brand{
    display:flex; align-items:center; gap:10px;
    color:#cfe0ff; font-weight:700; letter-spacing:.2px;
  }
  .brand img{height:72px; display:block}

  .toolbar{
    position:relative;
    z-index:1; /* acima da logo de fundo */
    max-width:1280px;
    margin:18px auto 8px;
    padding:14px 16px;
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:14px;
    display:grid;
    grid-template-columns: 1fr auto auto auto;
    gap:10px;
  }
  .toolbar label{color:#cfe0ff;font-size:12px;display:block;margin-bottom:6px}
  input,select,button{
    padding:10px 12px;
    border-radius:10px;
    border:1px solid var(--line);
    background:#f6f8ff;
    color:#111;
    outline:none;
  }
  input::placeholder{color:#8088a8}
  .btn{
    cursor:pointer;background:var(--btn);color:var(--ink-inv);
    border:none;font-weight:700;border-radius:10px;padding:10px 14px
  }
  .btn:hover{background:var(--btn-hover)}
  .btn.secondary{background:#44507c;color:#e9efff}

  /* Campo de busca GRANDE + botão ao lado */
  .search-wrap{display:flex;align-items:end;gap:8px}
  #search{width:min(720px, 100%)}   /* largo */
  #btnClearSearch{white-space:nowrap}

  main{
    position:relative; z-index:1; /* acima da logo de fundo */
    max-width:1280px;
    margin:8px auto 120px;
    padding:0 16px;
  }
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(360px,1fr));
    gap:16px;
  }

  /* --- CARTÃO --- */
  .card{border-radius:16px;overflow:hidden;border:3px solid var(--media-frame);background:#eef3ff}
  .media{
    background:var(--media-bg);
    border-bottom:3px solid var(--media-frame);
    display:flex;align-items:center;justify-content:center;
    aspect-ratio:16/12
  }
  .media img{max-width:95%;max-height:95%;object-fit:contain}
  .body{background:var(--card);color:#e9efff;border-top:1px solid var(--line);padding:12px}
  .title{font-weight:800;margin:0 0 8px}
  .row{display:flex;gap:8px;margin:8px 0}
  .row>*{flex:1;min-width:0}
  label{display:block;font-size:12px;margin-bottom:4px;opacity:.9}
  .price{background:#2f395e;color:#e9f2ff;border:1px solid #243055;width:100%}
  .qty{background:#eef3ff;width:100%}

  .include-btn{
    width:100%;padding:12px 14px;border-radius:12px;font-weight:800;
    background:var(--btn);color:#fff;border:none;cursor:pointer;
    box-shadow:0 2px 0 0 #425fb5;white-space:nowrap
  }
  .include-btn:hover{background:var(--btn-hover)}
  .include-btn[data-on="1"]{background:#2fbf71;box-shadow:0 2px 0 0 #1d7b49}

  .placeholder{
    margin:24px auto 0;padding:16px;border:1px dashed #9fb3ff;border-radius:12px;
    text-align:center;color:#3a4266;background:#f0f4ff;max-width:900px
  }

  /* ===== Preview (fechar orçamento) ===== */
  .overlay{position:fixed;inset:0;background:rgba(18,24,40,.6);display:none;align-items:flex-start;justify-content:center;z-index:50}
  .overlay.show{display:flex}
  .sheet{
    margin:24px;max-width:1180px;width:100%;background:#e8eeff;border:1px solid #a3b0ff;
    border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.35);overflow:hidden
  }
  .sheet header{position:sticky;top:0;background:#e8eeff;border-bottom:1px solid #a3b0ff}
  .sheet header .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 16px}
  .sheet header h3{margin:0;font-size:18px;color:#222}
  .sheet .meta{font-size:12px;color:#444}
  .sheet .content{padding:14px}

  .sel-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .sel-item{display:flex;gap:12px;border:1px solid #a3b0ff;border-radius:10px;background:#f6f8ff;padding:10px}
  .sel-item .imgbox{width:140px;height:110px;display:flex;align-items:center;justify-content:center;border:1px solid #d8e0ff;border-radius:8px;background:#fff;overflow:hidden}
  .sel-item img{max-width:100%;max-height:100%;object-fit:contain}
  .sel-item .info h4{margin:0 0 6px;font-size:15px}
  .sel-item .info .row{display:flex;gap:24px;font-size:13px}

  /* Tabela com cantos arredondados e linhas pretas */
  .tbl{
    width:100%;border-collapse:separate;border-spacing:0;margin-top:12px;background:#fff;
    border:1px solid var(--black);border-radius:10px;overflow:hidden
  }
  .tbl th,.tbl td{border:1px solid var(--black);padding:8px}
  .tbl th{background:#eef2ff;text-align:left}
  .right{text-align:right;font-variant-numeric:tabular-nums}
  .tbl tfoot td{font-weight:800}
  .tbl tr:first-child th:first-child{border-top-left-radius:10px}
  .tbl tr:first-child th:last-child{border-top-right-radius:10px}
  .tbl tfoot tr:last-child td:first-child{border-bottom-left-radius:10px}
  .tbl tfoot tr:last-child td:last-child{border-bottom-right-radius:10px}

  @media print{
    header,.toolbar,.placeholder,.overlay:not(.print){display:none!important}
    body{background:#fff}
    body::after{display:none}
    .sheet{margin:0;border:none;border-radius:0;box-shadow:none}
    .overlay.print{display:block}
  }
</style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="brand">
      <img src="imagens/logo-branca.png" alt="Vibaz Robótica" />
      <span>Vibaz Robótica</span>
    </div>
    <div style="margin-left:auto">
      <button class="btn" id="btnCloseQuote">Fechar orçamento</button>
    </div>
  </div>
</header>

<section class="toolbar">
  <div class="search-wrap">
    <div style="flex:1">
      <label>Pesquisar modelo</label>
      <input id="search" list="sug" placeholder="digite parte do nome..." />
      <datalist id="sug"></datalist>
    </div>
    <button class="btn secondary" id="btnClearSearch">Limpar busca</button>
  </div>

  <div style="align-self:end">
    <label>&nbsp;</label>
    <button class="btn secondary" id="btnClear">Remover todos</button>
  </div>

  <div>
    <label>UF do cliente</label>
    <select id="uf">
      <option value="AC">AC</option><option value="AL">AL</option><option value="AP">AP</option>
      <option value="AM">AM</option><option value="BA">BA</option><option value="CE">CE</option>
      <option value="DF">DF</option><option value="ES">ES</option><option value="GO">GO</option>
      <option value="MA">MA</option><option value="MT">MT</option><option value="MS">MS</option>
      <option value="MG">MG</option><option value="PA">PA</option><option value="PB">PB</option>
      <option value="PR" selected>PR</option><option value="PE">PE</option><option value="PI">PI</option>
      <option value="RJ">RJ</option><option value="RN">RN</option><option value="RS">RS</option>
      <option value="RO">RO</option><option value="RR">RR</option><option value="SC">SC</option>
      <option value="SP">SP</option><option value="SE">SE</option><option value="TO">TO</option>
      <option value="outros">Outros</option>
    </select>
  </div>

  <div>
    <label>Distância (Km) — aplica no 1º item incluído</label>
    <input id="km" type="number" min="0" step="1" value="0" />
  </div>
</section>

<main>
  <div id="hint" class="placeholder">Use a busca acima para listar os modelos.</div>
  <section id="catalog" class="grid"></section>
</main>

<!-- Preview / Fechar orçamento -->
<div class="overlay" id="overlay">
  <div class="sheet" id="sheet">
    <header>
      <div class="bar">
        <div>
          <h3>Orçamento — Vibaz Robótica</h3>
          <div class="meta" id="meta"></div>
        </div>
        <div>
          <button class="btn" id="btnPrint">Imprimir/Salvar PDF</button>
          <button class="btn secondary" id="btnBack">Voltar</button>
        </div>
      </div>
    </header>
    <div class="content">
      <div class="sel-grid" id="selGrid"></div>

      <table class="tbl" id="tbl">
        <thead>
          <tr>
            <th style="width:48%">Produto</th>
            <th>Qtd</th>
            <th class="right">Unit. (Valor líquido)</th>
            <th class="right">Unit. (Valor c/ impostos)</th>
            <th class="right">Total líquido</th>
            <th class="right">Total c/ impostos</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot>
          <tr><td colspan="6" class="right" id="subLiq">Subtotal valor líquido</td></tr>
          <tr><td colspan="6" class="right" id="subImp">Subtotal valor c/ impostos</td></tr>
          <tr><td colspan="6" class="right" id="totGeral">Total geral</td></tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<script>
/* ===== Helpers ===== */
const money = v => isFinite(v) ? v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : '-';
const parseBR = s => {
  if(typeof s==='number') return s;
  const x=String(s).replace(/[^\d,.-]+/g,'').replace(/\.(?=\d{3}(\D|$))/g,'').replace(',', '.');
  const n=parseFloat(x);
  return Number.isFinite(n)? n:0;
};

/* ===== Imagens com fallback ===== */
function candidatesFor(nome){
  const raw = String(nome||'').trim();
  const noAcc = raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  const cleaned = noAcc.replace(/[+]/g,'_').replace(/[^\w.\- ]+/g,'_').replace(/_/g,' ').replace(/\s+/g,' ').trim();
  const u = cleaned.replace(/\s+/g,'_'); const h = cleaned.replace(/\s+/g,'-');
  const bases=[raw,noAcc,cleaned,u,h,raw.toUpperCase(),noAcc.toUpperCase(),cleaned.toUpperCase(),u.toUpperCase(),h.toUpperCase(),raw.toLowerCase(),noAcc.toLowerCase(),cleaned.toLowerCase(),u.toLowerCase(),h.toLowerCase()].filter((v,i,a)=>v&&a.indexOf(v)===i);
  const out=[]; for(const b of bases){ out.push(`imagens/${b}.png`,`imagens/${b}.jpg`,`imagens/${b}.jpeg`); }
  return out;
}
function loadImageWithFallback(img, list, i=0){
  if(i>=list.length){ img.style.display='none'; return; }
  img.onerror=()=>loadImageWithFallback(img,list,i+1);
  img.onload =()=>{ img.style.display='block'; };
  img.src=list[i];
}

/* ===== Estado ===== */
const state={ uf:'PR', km:0, all:[], filtered:[] };

/* ===== DOM ===== */
const $=(s,e=document)=>e.querySelector(s);
const catalog=$('#catalog'), hint=$('#hint'), inputSearch=$('#search'), selectUF=$('#uf'), inputKM=$('#km');
const btnClear=$('#btnClear'), btnClearSearch=$('#btnClearSearch');
const btnCloseQuote=$('#btnCloseQuote'), overlay=$('#overlay'), btnPrint=$('#btnPrint'), btnBack=$('#btnBack');
const selGrid=$('#selGrid'), tbody=$('#tbody'), subLiq=$('#subLiq'), subImp=$('#subImp'), totGeral=$('#totGeral'), meta=$('#meta'), sug=$('#sug');

/* ===== Carregar JSON por UF ===== */
async function loadDataByUF(uf){
  const map={PR:'data/pr.json', outros:'data/outros.json'};
  const url= uf==='PR' ? map.PR : map.outros;
  const res=await fetch(url,{cache:'no-store'});
  const data=await res.json();
  state.all=data.map(x=>({
    nome:String(x.nome||x.modelo||x.Nome||'').trim(),
    ad:parseBR(x.ad??x.AD??x.sem_impostos??x.unit_sem??0),
    an:parseBR(x.an??x.AN??x.com_impostos??x.unit_com??0),
    qty:1, incluir:0
  })).filter(x=>x.nome);
  sug.innerHTML=state.all.map(it=>`<option value="${it.nome}">`).join('');
  state.filtered=[]; renderCards();
}

/* ===== Render ===== */
function renderCards(){
  catalog.innerHTML='';
  if(state.filtered.length===0){ hint.style.display='block'; return; }
  hint.style.display='none';
  state.filtered.forEach(it=>{
    const card=document.createElement('article'); card.className='card'; card.dataset.selected=it.incluir?'1':'0';
    const media=document.createElement('div'); media.className='media';
    media.innerHTML=`<img alt="${it.nome}" style="display:none">`;
    const imgEl=media.querySelector('img'); loadImageWithFallback(imgEl,candidatesFor(it.nome));
    const body=document.createElement('div'); body.className='body';
    body.innerHTML=`
      <div class="title">${it.nome}</div>
      <div class="row">
        <div><label>Valor líquido</label><input class="price" value="${money(it.ad)}" readonly></div>
        <div><label>Valor c/ impostos</label><input class="price" value="${money(it.an)}" readonly></div>
      </div>
      <div class="row">
        <div style="max-width:170px"><label>Quantidade</label><input class="qty" type="number" min="1" step="1" value="${it.qty}"></div>
        <div style="display:flex;align-items:flex-end"><button class="include-btn" data-on="${it.incluir?1:0}">${it.incluir?'Incluído':'Incluir'}</button></div>
      </div>
    `;
    body.querySelector('.qty').addEventListener('input',e=>{
      const v=Math.max(1,parseInt(e.target.value||'1',10)); it.qty=v; e.target.value=v;
    });
    const btn=body.querySelector('.include-btn');
    btn.addEventListener('click',()=>{
      it.incluir=it.incluir?0:1; btn.dataset.on=it.incluir?1:0; btn.textContent=it.incluir?'Incluído':'Incluir';
      card.dataset.selected=it.incluir?'1':'0';
    });

    card.append(media,body); catalog.appendChild(card);
  });
}

function applyFilter(){
  const q=inputSearch.value.trim().toLowerCase();
  if(q.length<1){ state.filtered=[]; renderCards(); return; }
  state.filtered=state.all.filter(it=>it.nome.toLowerCase().includes(q));
  renderCards();
}

/* ===== Preview (Fechar orçamento) ===== */
function buildPreview(){
  const km = Math.max(0, parseInt(inputKM.value||'0',10));
  const frete = km * 1.6; // aplica ao 1º item (valor líquido)
  const itensSel = state.all.filter(it=>it.incluir);

  selGrid.innerHTML=''; tbody.innerHTML='';
  subLiq.textContent='Subtotal valor líquido';
  subImp.textContent='Subtotal valor c/ impostos';
  totGeral.textContent='Total geral';
  meta.textContent=`Somente itens selecionados • UF: ${selectUF.value.toUpperCase()} • Distância: ${km} Km`;

  if(itensSel.length===0){
    selGrid.innerHTML='<div style="grid-column:1/-1;padding:10px;background:#fff;border:1px dashed #a3b0ff;border-radius:10px;text-align:center">Nenhum item selecionado.</div>';
    return;
  }

  itensSel.forEach((it,idx)=>{
    const box=document.createElement('div'); box.className='sel-item';
    box.innerHTML=`
      <div class="imgbox"><img alt="${it.nome}"></div>
      <div class="info">
        <h4>${it.nome}</h4>
        <div class="row"><div>Valor líquido: <b>${money(it.ad)}</b></div><div>Valor c/ impostos: <b>${money(it.an)}</b></div></div>
        <div class="row"><div>Total líquido: <b>${money(it.ad * it.qty + (idx===0?frete:0))}</b></div><div>Total c/ impostos: <b>${money(it.an * it.qty)}</b></div></div>
        <div>Qtd: <b>${it.qty}</b></div>
      </div>
    `;
    const img=box.querySelector('img'); loadImageWithFallback(img,candidatesFor(it.nome));
    selGrid.appendChild(box);
  });

  let subtotalLiq=0, subtotalImp=0;
  itensSel.forEach((it,idx)=>{
    const unitLiq = it.ad;
    const unitImp = it.an;
    const totalLiq = unitLiq * it.qty + (idx===0?frete:0);
    const totalImp = unitImp * it.qty;
    subtotalLiq += totalLiq;
    subtotalImp += totalImp;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${it.nome}</td>
      <td class="right">${it.qty}</td>
      <td class="right">${money(unitLiq)}</td>
      <td class="right">${money(unitImp)}</td>
      <td class="right">${money(totalLiq)}</td>
      <td class="right">${money(totalImp)}</td>
    `;
    tbody.appendChild(tr);
  });

  subLiq.textContent = `Subtotal valor líquido       ${money(subtotalLiq)}`;
  subImp.textContent  = `Subtotal valor c/ impostos   ${money(subtotalImp)}`;
  totGeral.textContent= `Total geral                   ${money(subtotalImp)}`;
}

/* ===== Eventos ===== */
inputSearch.addEventListener('input',applyFilter);
btnClearSearch.addEventListener('click',()=>{inputSearch.value=""; applyFilter();});
selectUF.addEventListener('change',async()=>{
  state.uf=selectUF.value;
  await loadDataByUF(state.uf);
  applyFilter();
});
inputKM.addEventListener('input',e=>{state.km=Math.max(0,parseInt(e.target.value||'0',10));});
btnClear.addEventListener('click',()=>{
  state.all.forEach(it=>it.incluir=0);
  state.filtered.forEach(it=>it.incluir=0);
  renderCards();
});

btnCloseQuote.addEventListener('click',()=>{ buildPreview(); overlay.classList.add('show'); });
btnBack.addEventListener('click',()=>overlay.classList.remove('show'));
btnPrint.addEventListener('click',()=>{
  overlay.classList.add('print');
  window.print();
  overlay.classList.remove('print');
});

/* ===== Boot ===== */
(async function init(){ await loadDataByUF(state.uf); })();
</script>
</body>
</html>
